generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id                   String   @id @default(uuid())
  email                String   @unique
  name                 String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  bridges              Bridge[]
  
  // Stripe Subscription
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  subscriptionStatus   String?  // "active" | "cancelled" | "past_due" | "trialing"
  subscriptionPlan     String?  // "FREELANCER" | "AGENCY" | "ENTERPRISE"
  bridgeLimit          Int      @default(1)
}

model Bridge {
  id                  String       @id @default(uuid())
  name                String
  userId              String
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  status              BridgeStatus @default(STOPPED)
  containerId         String?
  
  // Slack Configuration
  slackToken          String
  slackChannel        String
  slackTeamName       String       @default("agency")
  
  // Teams Configuration
  teamsAppId          String
  teamsAppPassword    String
  teamsTenantId       String
  teamsTeamId         String
  teamsChannel        String
  
  // Intelligence Layer
  apiToken            String       @default(uuid())
  intelligenceEnabled Boolean      @default(true)
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  messageLogs         MessageLog[]
}

model MessageLog {
  id        String   @id @default(uuid())
  bridgeId  String
  bridge    Bridge   @relation(fields: [bridgeId], references: [id], onDelete: Cascade)
  platform  String   // "slack" | "teams" | "api"
  sender    String
  content   String
  embedding Unsupported("vector(1536)")?
  timestamp DateTime @default(now())
  
  @@index([bridgeId])
}

enum BridgeStatus {
  STOPPED
  STARTING
  RUNNING
  ERROR
}
